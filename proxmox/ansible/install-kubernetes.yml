---
- hosts: "masters"
  become: yes
  remote_user: ubuntu

  tasks:

    - name: Install dependencies
      shell: |
            apt update
            apt -y install curl apt-transport-https vim git curl wget kubelet kubeadm kubectl
            curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | apt-key add -
            echo "deb https://apt.kubernetes.io/ kubernetes-xenial main" | tee /etc/apt/sources.list.d/kubernetes.list
            apt-mark hold kubelet kubeadm kubectl

    - name: Disable swap
      shell: |
            sed -i '/ swap / s/^\(.*\)$/#\1/g' /etc/fstab
            swapoff -a
            mount -a

    - name: Config systemctl
      shell: |
            tee /etc/sysctl.d/kubernetes.conf<<EOF
            net.bridge.bridge-nf-call-ip6tables = 1
            net.bridge.bridge-nf-call-iptables = 1
            net.ipv4.ip_forward = 1
            EOF

            sysctl --system

    - name: Install crio
      shell: |
            modprobe overlay
            modprobe br_netfilter
            OS="xUbuntu_20.04"
            VERSION=1.26
            echo "deb https://download.opensuse.org/repositories/devel:/kubic:/libcontainers:/stable/$OS/ /" > /etc/apt/sources.list.d/devel:kubic:libcontainers:stable.list
            echo "deb http://download.opensuse.org/repositories/devel:/kubic:/libcontainers:/stable:/cri-o:/$VERSION/$OS/ /" > /etc/apt/sources.list.d/devel:kubic:libcontainers:stable:cri-o:$VERSION.list
            curl -L https://download.opensuse.org/repositories/devel:kubic:libcontainers:stable:cri-o:$VERSION/$OS/Release.key | apt-key add -
            curl -L https://download.opensuse.org/repositories/devel:/kubic:/libcontainers:/stable/$OS/Release.key | apt-key add -
            apt update
            apt install -y cri-o cri-o-runc 
            sed -i 's/10.85.0.0/192.168.0.0/g' /etc/cni/net.d/100-crio-bridge.conflist
            systemctl daemon-reload
            systemctl restart crio
            systemctl enable crio

